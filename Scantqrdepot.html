<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DepotScan - Quản lý Container</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
        header { 
            background: #2c3e50; 
            color: #fff; 
            padding: 10px 20px; 
            display: flex; /* Sử dụng flexbox */
            justify-content: space-between; /* Đẩy các phần tử ra xa nhau */
            align-items: center; /* Căn giữa theo chiều dọc */
        }
        header h1 { 
            margin: 0; 
            flex-grow: 1; /* Cho phép tiêu đề mở rộng */
            text-align: center; /* Căn giữa tiêu đề */
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px; /* Khoảng cách giữa các phần tử */
        }
        .user-info span {
            font-weight: bold;
            color: #ecf0f1; /* Màu chữ sáng hơn */
        }
        .user-info button {
            background: #e74c3c; /* Màu đỏ cho nút đăng xuất */
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .user-info button:hover {
            opacity: 0.8;
        }

        nav { display: flex; background: #34495e; flex-wrap: wrap; }
        nav button { flex: 1; padding: 10px; background: #34495e; color: #fff; border: none; cursor: pointer; }
        nav button:hover { background: #2c3e50; }
        .tab { display: none; padding: 20px; max-width: 600px; margin: auto; }
        .active { display: block; }
        input, select, button { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #28a745; color: white; cursor: pointer; border: none; }
        button:hover { opacity: 0.9; }
        .container-card { background: #fff; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .container-card button { width: auto; padding: 5px 10px; margin-right: 5px; margin-top: 5px; font-size: 0.9em; }
        .container-card .delete-btn { background: #dc3545; }
        .qr-code { margin-top: 10px; display: block; } /* Ensure canvas is block for proper sizing */
        .auth-box { max-width: 400px; margin: 50px auto; background: #fff; padding: 20px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        #searchInput { margin: 10px auto; display: block; width: 90%; padding: 8px; }
        #qr-result { margin-top: 10px; background: #e9ecef; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; }
        #qr-result h3 { margin-top: 0; color: #0056b3; }
        #qr-result .not-found { color: #dc3545; font-weight: bold; }
        .qr-scan-details button { width: auto; margin-right: 5px; }
        #qr-image-input { display: none; } /* Ẩn input file gốc */
        .qr-action-buttons { display: flex; justify-content: space-around; margin-top: 15px; }
        .qr-action-buttons button { flex: 1; margin: 0 5px; }
    </style>
</head>
<body>
    <header>
        <h1>DepotScan</h1>
        <div id="userInfoDisplay" class="user-info" style="display:none;">
            <span>Xin chào, <span id="loggedInUsername"></span>!</span>
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="auth" class="auth-box">
        <h2>Đăng ký / Đăng nhập</h2>
        <input type="text" id="authUser" placeholder="Tên người dùng" />
        <input type="password" id="authPass" placeholder="Mật khẩu" />
        <button onclick="login()">Bắt đầu</button>
    </div>

    <div id="app" style="display:none">
        <nav>
            <button onclick="switchTab('addTab')"><i class="fas fa-plus-square"></i> Thêm Container</button>
            <button onclick="switchTab('listTab')"><i class="fas fa-list"></i> Danh sách Container</button>
            <button onclick="switchTab('scanTab')"><i class="fas fa-qrcode"></i> Quét QR</button>
        </nav>

        <div id="addTab" class="tab active">
            <h2>Thêm Container</h2>
            <input id="contId" placeholder="Mã container (duy nhất)" />
            <input id="contPos" placeholder="Vị trí trong bãi" />
            <select id="contStatus">
                <option value="Còn nguyên">Còn nguyên</option>
                <option value="Đã rút hàng">Đã rút hàng</option>
                <option value="Đang sửa chữa">Đang sửa chữa</option>
                <option value="Đang vận chuyển">Đang vận chuyển</option>
            </select>
            <input type="datetime-local" id="contTime" />
            <input id="contNote" placeholder="Ghi chú" />
            <button onclick="addContainer()">Lưu container</button>
        </div>

        <div id="listTab" class="tab">
            <h2>Danh sách Container</h2>
            <input id="searchInput" placeholder="Tìm theo mã container..." oninput="filterContainers(this.value)" />
            <div id="containerList"></div>
        </div>

        <div id="scanTab" class="tab">
            <h2><i class="fas fa-qrcode"></i> Quét mã QR</h2>
            <div id="qr-reader" style="width: 100%;"></div>
            <div class="qr-action-buttons">
                <button onclick="document.getElementById('qr-image-input').click()">Ảnh có sẵn</button>
                <input type="file" id="qr-image-input" accept="image/*" onchange="scanFromImage(event)">
                <button onclick="startQRScanner()">Khởi động lại Camera</button>
            </div>
            <div id="qr-result" style="margin-top: 10px; min-height: 100px;">
                <p>Hướng camera vào mã QR để quét.</p>
                <p>Đảm bảo đã cấp quyền truy cập camera cho trình duyệt.</p>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục để lưu trữ instance của Html5Qrcode
        let html5QrCodeScanner = null;

        // Hàm kiểm tra và tự động đăng nhập nếu có tên người dùng đã lưu
        function checkAndAutoLogin() {
            const savedUser = localStorage.getItem('depotScanUser'); // Lấy tên người dùng đã lưu từ localStorage
            if (savedUser) {
                document.getElementById('authUser').value = savedUser; // Điền tên người dùng vào trường đăng nhập (tùy chọn)
                document.getElementById('auth').style.display = 'none'; // Ẩn hộp đăng nhập
                document.getElementById('app').style.display = 'block'; // Hiển thị ứng dụng
                
                // Hiển thị tên người dùng đã đăng nhập
                document.getElementById('loggedInUsername').textContent = savedUser;
                document.getElementById('userInfoDisplay').style.display = 'flex'; // Hiển thị phần thông tin người dùng
                
                loadContainers(); // Tải danh sách container
            }
        }

        function login() {
            const user = document.getElementById('authUser').value.trim(); // Lấy giá trị từ input tên người dùng và xóa khoảng trắng
            const pass = document.getElementById('authPass').value.trim(); // Lấy giá trị từ input mật khẩu và xóa khoảng trắng
            
            // Trong ứng dụng thực tế, bạn sẽ gửi thông tin này đến máy chủ để xác thực.
            // Ở đây, chỉ cần có bất kỳ ký tự nào là được coi là đăng nhập thành công.
            if (user && pass) {
                localStorage.setItem('depotScanUser', user); // Lưu tên người dùng vào localStorage
                document.getElementById('auth').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Cập nhật và hiển thị tên người dùng
                document.getElementById('loggedInUsername').textContent = user;
                document.getElementById('userInfoDisplay').style.display = 'flex';
                
                loadContainers();
            } else {
                alert('Vui lòng nhập tên và mật khẩu.');
            }
        }

        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất không?')) {
                localStorage.removeItem('depotScanUser'); // Xóa tên người dùng khỏi localStorage
                document.getElementById('app').style.display = 'none'; // Ẩn ứng dụng
                document.getElementById('userInfoDisplay').style.display = 'none'; // Ẩn thông tin người dùng
                document.getElementById('auth').style.display = 'block'; // Hiển thị lại hộp đăng nhập
                document.getElementById('authPass').value = ''; // Xóa mật khẩu đã nhập
                
                // Dừng scanner nếu đang chạy khi đăng xuất
                if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                    html5QrCodeScanner.stop().then(() => {
                        console.log("QR scanner stopped on logout.");
                    }).catch(err => {
                        console.warn("Error stopping QR scanner on logout:", err);
                    });
                }
            }
        }

        async function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // Luôn dừng scanner khi chuyển tab
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) { 
                try {
                    await html5QrCodeScanner.stop();
                    console.log("QR scanner stopped.");
                } catch (err) {
                    console.warn("Error stopping QR scanner:", err);
                }
            }

            // Khởi động scanner chỉ khi vào tab quét QR
            if (tabId === 'scanTab') {
                startQRScanner();
            } else {
                // Xóa kết quả quét cũ khi chuyển khỏi tab quét
                document.getElementById("qr-result").innerHTML = '<p>Hướng camera vào mã QR để quét.</p><p>Đảm bảo đã cấp quyền truy cập camera cho trình duyệt.</p>';
            }
        }

        function getStoredContainers() {
            return JSON.parse(localStorage.getItem('containers') || '[]');
        }

        function saveContainers(containers) {
            localStorage.setItem('containers', JSON.stringify(containers));
        }

        function addContainer() {
            const id = document.getElementById('contId').value.trim();
            const pos = document.getElementById('contPos').value.trim();
            const status = document.getElementById('contStatus').value;
            const time = document.getElementById('contTime').value;
            const note = document.getElementById('contNote').value.trim();

            if (!id || !pos || !time) {
                alert('Vui lòng nhập đầy đủ thông tin: Mã container, Vị trí và Giờ vào.');
                return;
            }

            const containers = getStoredContainers();
            if (containers.find(c => c.id === id)) {
                alert('Mã container đã tồn tại! Vui lòng nhập mã khác.');
                return;
            }

            const data = { id, pos, status, time, note };
            containers.push(data);
            saveContainers(containers);
            renderContainer(data); // Thêm vào danh sách hiển thị
            clearForm();
            alert('Container đã được lưu thành công!');
        }

        function renderContainer(data) {
            const { id, pos, status, time, note } = data;
            const infoForQR = id;

            const contCard = document.createElement('div');
            contCard.className = 'container-card';
            contCard.dataset.id = id;
            contCard.innerHTML = `
                <strong>Mã: ${id}</strong><br>
                Vị trí: ${pos}<br>
                Trạng thái: ${status}<br>
                Giờ vào: ${time}<br>
                Ghi chú: ${note || '(Không có)'}<br>
                <canvas class="qr-code" id="qr-${id}"></canvas><br>
                <button onclick="downloadQRCode('${id}')">⬇️ Xuất mã QR</button>
                <button class="delete-btn" onclick="deleteContainer('${id}', this)">❌ Xóa</button>
            `;
            document.getElementById('containerList').prepend(contCard); 

            const canvas = document.getElementById(`qr-${id}`);
            if (canvas && QRCode && QRCode.toCanvas) {
                QRCode.toCanvas(canvas, infoForQR, { width: 128, errorCorrectionLevel: 'H' }, err => {
                    if (err) {
                        console.error('Lỗi khi tạo mã QR:', err);
                        canvas.style.display = 'none'; 
                    }
                });
            }
        }

        function deleteContainer(id, button) {
            if (!confirm(`Bạn có chắc muốn xóa container có mã "${id}" không?`)) {
                return;
            }
            let containers = getStoredContainers();
            containers = containers.filter(c => c.id !== id);
            saveContainers(containers);
            button.parentElement.remove();
            alert(`Container "${id}" đã được xóa.`);
        }

        function clearForm() {
            document.getElementById('contId').value = '';
            document.getElementById('contPos').value = '';
            document.getElementById('contNote').value = '';
            document.getElementById('contTime').value = '';
            document.getElementById('contStatus').value = 'Còn nguyên'; 
        }

        function loadContainers() {
            const containerListDiv = document.getElementById('containerList');
            containerListDiv.innerHTML = ''; 
            const containers = getStoredContainers();
            containers.reverse().forEach(renderContainer); 
        }

        function filterContainers(keyword) {
            keyword = keyword.toLowerCase();
            document.querySelectorAll('.container-card').forEach(card => {
                const id = card.dataset.id.toLowerCase();
                card.style.display = id.includes(keyword) ? '' : 'none';
            });
        }

        async function startQRScanner() {
            const qrCodeRegionId = "qr-reader";
            if (!html5QrCodeScanner) {
                html5QrCodeScanner = new Html5Qrcode(qrCodeRegionId);
            }
            const qrResultDiv = document.getElementById("qr-result");
            qrResultDiv.innerHTML = '<p>Đang khởi động camera...</p>';

            try {
                if (html5QrCodeScanner.isScanning) {
                    await html5QrCodeScanner.stop();
                    console.log("Scanner stopped before restart.");
                }

                const devices = await Html5Qrcode.getCameras();
                if (devices && devices.length) {
                    const cameraId = devices.find(device => device.facingMode === 'environment')?.id || devices[0].id;

                    await html5QrCodeScanner.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 },
                            rememberLastUsedCamera: true
                        },
                        (qrCodeMessage) => {
                            displayScannedContainerInfo(qrCodeMessage);
                            html5QrCodeScanner.stop().then(() => {
                                console.log("QR scanning stopped after success.");
                            }).catch(err => {
                                console.warn("Error stopping QR scanner after success:", err);
                            });
                        },
                        (errorMessage) => {
                            // console.warn(`QR Code scanning error: ${errorMessage}`);
                        }
                    );
                    qrResultDiv.innerHTML = '<p>Đã sẵn sàng quét. Hướng camera vào mã QR.</p>';
                } else {
                    qrResultDiv.innerHTML = '<p class="not-found">Không tìm thấy camera nào trên thiết bị này.</p>';
                }
            } catch (err) {
                qrResultDiv.innerHTML = `<p class="not-found">Lỗi khi khởi động camera: ${err.message || err}.</p>
                                        <p>Vui lòng kiểm tra lại quyền truy cập camera của trình duyệt trong cài đặt thiết bị.</p>`;
                console.error("Lỗi khởi động Html5Qrcode:", err);
            }
        }

        async function scanFromImage(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const qrResultDiv = document.getElementById("qr-result");
            qrResultDiv.innerHTML = '<p>Đang xử lý ảnh...</p>';

            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                try {
                    await html5QrCodeScanner.stop();
                    console.log("Camera stopped before image scan.");
                } catch (err) {
                    console.warn("Error stopping camera before image scan:", err);
                }
            }
            
            document.getElementById("qr-reader").innerHTML = '';

            Html5Qrcode.scanFile(file, true)
                .then(qrCodeMessage => {
                    displayScannedContainerInfo(qrCodeMessage);
                    event.target.value = ''; 
                })
                .catch(err => {
                    qrResultDiv.innerHTML = `<p class="not-found">Không thể tìm thấy mã QR trong ảnh này. Vui lòng thử ảnh khác.</p>
                                            <p>Lỗi: ${err}</p>`;
                    console.error("Error scanning image:", err);
                    event.target.value = '';
                });
        }

        function displayScannedContainerInfo(containerId) {
            const qrResultDiv = document.getElementById("qr-result");
            const containers = getStoredContainers();
            const foundContainer = containers.find(c => c.id === containerId);

            if (foundContainer) {
                qrResultDiv.innerHTML = `
                    <h3>Thông tin Container Đã Quét:</h3>
                    <strong>Mã: ${foundContainer.id}</strong><br>
                    Vị trí: ${foundContainer.pos}<br>
                    Trạng thái: ${foundContainer.status}<br>
                    Giờ vào: ${foundContainer.time}<br>
                    Ghi chú: ${foundContainer.note || '(Không có)'}<br>
                    <div class="qr-scan-details" style="margin-top: 10px;">
                        <button onclick="downloadQRCode('${foundContainer.id}')">⬇️ Xuất mã QR</button>
                        <button class="delete-btn" onclick="deleteContainer('${foundContainer.id}', this.parentElement.parentElement)">❌ Xóa Container</button>
                        <button onclick="switchTab('addTab'); 
                                        document.getElementById('contId').value='${foundContainer.id}'; 
                                        document.getElementById('contPos').value='${foundContainer.pos}';
                                        document.getElementById('contStatus').value='${foundContainer.status}';
                                        document.getElementById('contTime').value='${foundContainer.time}';
                                        document.getElementById('contNote').value='${foundContainer.note}';">✏️ Chỉnh sửa (điền vào form)</button>
                    </div>
                `;
            } else {
                qrResultDiv.innerHTML = `
                    <p class="not-found">Không tìm thấy container với mã: <strong>${containerId}</strong> trong danh sách.</p>
                    <p>Bạn có muốn thêm container này không?</p>
                    <button onclick="switchTab('addTab'); document.getElementById('contId').value='${containerId}';">➕ Thêm container mới với mã này</button>
                `;
            }
        }

        function downloadQRCode(id) {
            const canvas = document.getElementById(`qr-${id}`);
            if (!canvas) {
                alert("Không tìm thấy mã QR để tải xuống! Vui lòng chuyển đến tab 'Danh sách Container' và thử lại.");
                return;
            }
            const link = document.createElement('a');
            link.download = `QR_Container_${id}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Gọi hàm này khi trang tải xong để kiểm tra tự động đăng nhập
        window.onload = checkAndAutoLogin;
    </script>
</body>
</html>